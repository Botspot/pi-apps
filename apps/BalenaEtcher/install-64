#!/bin/bash

#etcher debs compiled by Itai Nelken.

DIRECTORY="$(dirname "$(dirname "$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )")")"

function error {
  echo -e "\\e[91m$1\\e[39m"
  exit 1
}

function download_latest_release_arm64() {
  echo "Downloading latest arm64 release..."
  curl -s https://api.github.com/repos/$1/releases/latest \
  | grep "browser_download_url.*armv64.deb" \
  | cut -d : -f 2,3 \
  | tr -d \" \
  | wget -qi -
}

# Get dependencies
"${DIRECTORY}/pkg-install" "curl" "$(dirname "$0")" || exit 1

cd $HOME
rm -f ./balena-etcher-electron_*_arm64.deb 2>/dev/null
download_latest_release_arm64 Itai-Nelken/Etcher-arm-32-64
sudo apt install -y --fix-broken ~/balena-etcher-electron_*_arm64.deb  || error "failed to install deb file!"
rm -f ~/balena-etcher-electron_*_arm64.deb
exit 0

