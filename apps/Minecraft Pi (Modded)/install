#!/bin/bash

##
## Config
##

set -e

DIRECTORY="$(dirname "$(dirname "$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )")")"

function error {
  echo -e "\\e[91m$1\\e[39m"
  exit 1
}

# Wait for apt lock to be released
i=0
while sudo fuser /var/{lib/{dpkg,apt/lists},cache/apt/archives}/lock > /dev/null 2>&1
do
  case $(($i % 4)) in
    0) j="-";;
    1) j="\\";;
    2) j="|";;
    3) j="/";;
  esac
  printf "\r[$j] Waiting for other package managers to finish..."
  sleep 0.5
  ((i+=1))
done
[[ $i -gt 0 ]] && printf "Done.\n"

# Remove old MCPILs
sudo apt-get remove -y mcpil-r mcpil &>/dev/null || true
echo "Don't worry if above 2 lines look like errors, if they show up for you it means all is well!"

wget --no-cache -q -O - https://raw.githubusercontent.com/MCPI-Revival/mcpi-packages/master/install.sh | sudo bash - || error "Failed to install APT repo!"

# Choose MCPIL to use
PS3="Which launcher for MCPI Modded would you like to use? Need help deciding? Ask here: https://discord.com/invite/aDqejQGMMy
"
options=("gMCPIL (recommended)" "jMCPIL (better GUI)" "Quit")
select opt in "${options[@]}"
do
  case $opt in
    "${options[0]}")
        MCPIL="gmcpil"
        break;;
    "${options[1]}")
        MCPIL="jmcpil"
        break;;
    "${options[2]}")
        exit 0;;
    *) echo "Invalid option: $REPLY";;
  esac
done

"${DIRECTORY}/pkg-install" "${MCPIL} python3-pip minecraft-pi-reborn-client" "$(dirname "$0")"
pip3 install mcpi

echo "MCPI Modded installed successfully! Please note that you should regularly check for game and OS updates with 'sudo apt update && sudo apt upgrade'!"
