#!/bin/bash

### Install dependencies
install_packages lsb-release wget gpg || error "Failed to install dependencies"

### Make directory ~/Unciv if not available
mkdir -p $HOME/Unciv || error "Failed to create folder $HOME/Unciv"

### Add LICENSE from Github if doesn't exist
status "Adding license file"
wget -O ~/Unciv/LICENSE https://raw.githubusercontent.com/yairm210/Unciv/master/LICENSE || error 'Failed to download license!'

### download temurin-8-jdk
# the 'default-jre' (OpenJDK-11-jre) package takes too much RAM and runs very sloppy in Raspberry Pi 3B+
# so, we will use Temurin OpenJDK 8 installation cause thats the minimal Java version Unciv needs
# Temurin very smoothly on Raspberry Pi 3B+ without any problems
if [ "$arch" == 32 ]; then
  wget -O "$HOME/Unciv/openjdk-8.tar.gz" https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u312-b07/OpenJDK8U-jre_arm_linux_hotspot_8u312b07.tar.gz || exit 1
elif [ "$arch" == 64 ]; then
  wget -O "$HOME/Unciv/openjdk-8.tar.gz" https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u312-b07/OpenJDK8U-jre_aarch64_linux_hotspot_8u312b07.tar.gz
else
  error "Cannot detect architecture."
fi

tar -xf "$HOME/Unciv/openjdk-8.tar.gz" -C  "$HOME/Unciv" || error "Failed to extract $HOME/Unciv/openjdk-8.tar.gz"

if [ "$arch" == 32 ]; then
  mv -f "$HOME/Unciv/jdk8u312-b07-aarch32-20211101-jre" "$HOME/Unciv/openjdk-8-jre" || error "Failed to rename "$HOME/Unciv/jdk8u312-b07-aarch32-20211101-jre" to "$HOME/Unciv/openjdk-8-jre""
elif [ "$arch" == 64 ]; then
  mv -f "$HOME/Unciv/jdk8u312-b07-jre" "$HOME/Unciv/openjdk-8-jre" || error "Failed to rename "$HOME/Unciv/jdk8u312-b07-jre" to "$HOME/Unciv/openjdk-8-jre""
else
  error "Cannot detect architecture."
fi
rm -rf "$HOME/Unciv/openjdk-8.tar.gz" 

### Download Unciv.jar
wget -O "$HOME/Unciv/Unciv.jar" https://github.com/yairm210/Unciv/releases/download/3.18.11/Unciv.jar || exit 1

status "Creating runner script ($HOME/Unciv/Unciv.sh)"
# This is necessary because some special characters are supported in Desktop Entry Files.
# Without running Unciv.jar from ~/Unciv, the Game Data will be saved in ~ by default (not ~/Unciv).
# see https://github.com/yairm210/Unciv/blob/master/desktop/linuxFilesForJar/Unciv.sh
echo "\
cd $HOME/Unciv
"$HOME/Unciv/openjdk-8-jre/bin/java" -jar ./Unciv.jar" > ~/Unciv/Unciv.sh || error "Failed to write $HOME/Unciv/Unciv.sh!"

chmod +x $HOME/Unciv/Unciv.sh || error "Failed to make $HOME/Unciv/Unciv.sh executable!"

echo "\
[Desktop Entry]
Comment=Open-source Android/Desktop remake of Civ V
Exec=$HOME/Unciv/Unciv.sh
GenericName=4X Game
Icon=$(dirname "$0")/icon-64.png
Name=Unciv
NoDisplay=false
StartupNotify=true
Terminal=false
Type=Application
Categories=Game" \
> ~/.local/share/applications/unciv.desktop || error 'Failed to make menu button for Unciv!'
