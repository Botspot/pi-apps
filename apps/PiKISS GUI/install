#!/bin/bash

git_clone https://github.com/Jai-JAP/pikiss-gui || error 'Failed to clone PiKISS GUI repository!'

install_packages ninja-build gobject-introspection libgee-0.8-dev libgirepository1.0-dev libgtk-3-dev valac libgnome-menu-3-dev || exit 1
sudo pip3 install meson || error 'Failed to install meson from pip'
"${DIRECTORY}/manage" install-if-not-installed piKiss || error "piKiss failed to install somehow!"

cd pikiss-gui || error 'Failed to cd into pikiss-gui folder'

#Ouptut fix
mv meson.build meson.build.orig || error 'Failed to move meson.build to meson.build.orig'
sed 's|^meson.add_install_script|# meson.add_install_script|' meson.build.orig > meson.build || error 'Failed to comment addition of post_install script in meson.build'
echo "run_target('postinst', command: ['post_install.sh'], env: {'MESON_INSTALL_PREFIX': prefix})" >> meson.build || error 'Failed to create new postinst target in meson.build'
mv post_install.sh postinstall.sh.orig || error 'Failed to move post_install.sh to post_install.sh.orig'
awk '/tput cvvis/{f=0;next} /x=10/{f=1} !f' pikiss-gui/post_install.sh.orig > post_install.sh || error 'Failed to create modified post_install script'
chmod +x post_install.sh || error 'Failed to make post_install script executable'

rm -rf ./build 
meson --prefix=${HOME}/.local -Dbuildtype=release build || error 'Failed to generate build config'
ninja -C build -j4 || error 'Failed to build PiKISS GUI'
sudo ninja -C build install || error 'Failed to run "sudo ninja install"' 
sudo ninja -C build postinst || error 'Failed to run "sudo ninja postinst"'
rm -rf ./build

