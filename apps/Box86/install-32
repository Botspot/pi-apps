#!/bin/bash

DIRECTORY="$(dirname "$(dirname "$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )")")"

function error {
  echo -e "\\e[91m$1\\e[39m"
  exit 1
}

echo -n "Checking for working systemd-binfmt..."
if ! sudo systemctl restart systemd-binfmt ;then
  echo -e "\nError: systemd-binfmt failed to restart. Running debug..."
  echo 'systemctl status systemd-binfmt.service'
  systemctl status systemd-binfmt.service
  echo 'systemctl status systemd-binfmt.service'
  journalctl -xe | cat
  error "Exiting now because systemd-binfmt failed to restart."
else
  echo "Done"
fi

sudo rm -f /etc/apt/sources.list.d/box86.list
echo "adding box86 repo..."
sudo wget https://itai-nelken.github.io/weekly-box86-debs/debian/box86.list -O /etc/apt/sources.list.d/box86.list || error "Failed to download /etc/apt/sources.list.d/box86.list"

echo "adding key..."
wget -qO- https://itai-nelken.github.io/weekly-box86-debs/debian/KEY.gpg | sudo apt-key add - || error "Failed to add key to box86 repo!"

echo "installing box86..."
apt download box86 || error "Failed to download box86 package!"
DEB="$(basename box86*.deb)"
DEBDIR="$(echo $DEB | sed 's/.deb//')"

dpkg-deb -R $DEB $DEBDIR
rm $DEBDIR/DEBIAN/postinst || error "Failed to remove '$DEBDIR/DEBIAN/postinst' file!"
rm $DEB # doesn't matter if fails
dpkg-deb -b $DEBDIR $DEB
"${DIRECTORY}/pkg-install" "$(pwd)/$DEB" "$(dirname "$0")" || exit 1
echo 'restarting systemd-binfmt...'
sudo systemctl restart systemd-binfmt || error "Failed to restart systemd-binfmt!"

